"use strict";
const fs = require("fs-extra");
const path = require("path");
function cliPluginMain(api, options, rootOptions) {
    api.extendPackage((pkg) => {
        console.log(`[Generator] extendPackage`);
        console.dir(pkg);
        let deps = {};
        let depsDev = {};
        if (options.depsVueAnalytics) {
            deps["vue-analytics"] = "^5.16.4";
        }
        if (options.depsVueHeadful) {
            deps["vue-headful"] = "^2.0.1";
        }
        if (options.depsVueSession) {
            deps["vue-session"] = "^1.0.0";
        }
        if (options.depsVueGlobalEvents) {
            deps["vue-global-events"] = "^1.1.2";
        }
        if (options.depsBluebird) {
            deps["bluebird"] = "^3.5.4";
        }
        pkg.dependencies = {
            ...deps,
            ...pkg.dependencies,
        };
        pkg.devDependencies = {
            ...depsDev,
            "@types/node": "^11",
            "@bluelovers/tsconfig": "^1.0.3",
            "@types/webpack-chain": "^5.2.0",
            "terser": "3.17.0",
            "terser-webpack-plugin": "^1.2.3",
            ...pkg.devDependencies,
        };
        return pkg;
    });
    console.log(`[Generator] options`);
    console.dir(options);
    console.log(`[Generator] rootOptions`);
    console.dir(rootOptions);
    api.injectImports(api.entryFile, `import { production, development } from '@/lib/const'`);
    let files_not_exists = Object.entries([
        'tsconfig.json',
        '.browserslistrc',
    ].reduce((a, file) => {
        a[file] = file;
        return a;
    }, Object.entries({
        '.gitignore': 'gitignore',
        '.nvmrc': 'nvmrc',
        'public/nojekyll': 'nojekyll',
    }).reduce((a, [file, file2]) => {
        file2 = path.join('dot', file2);
        a[file] = file2;
        return a;
    }, (() => {
        let ret = {
            'public/_headers': '_headers',
            'src/lib/const.ts': 'src/lib/const.ts',
        };
        if (options.depsVueAnalytics) {
            ret['src/plugins/vue-analytics.ts'] = 'src/plugins/vue-analytics.ts';
            api.injectImports(api.entryFile, `import '@/plugins/vue-analytics'`);
        }
        return ret;
    }))()))
        .reduce((a, [file, file2]) => {
        let fpath = api.resolve(file);
        let exists = fs.existsSync(fpath);
        if (!exists || options.replaceFiles) {
            let fpath2 = path.resolve(__dirname, 'files', file2);
            let exists2 = fs.existsSync(fpath2);
            if (exists2) {
                if (exists) {
                    let bak = fpath + '.bak';
                    if (fs.existsSync(bak)) {
                        if (!fs.readFileSync(fpath).equals(fs.readFileSync(bak))) {
                            console.log(`[Generator] backup ${file}`);
                            fs.unlinkSync(bak);
                            fs.copyFileSync(fpath, bak);
                        }
                        else {
                            console.log(`[Generator] skip backup ${file}`);
                        }
                    }
                    else {
                        console.log(`[Generator] backup ${file}`);
                        fs.copyFileSync(fpath, bak);
                    }
                }
                a[file] = fpath2;
            }
        }
        return a;
    }, {});
    api.onCreateComplete(() => {
        console.log(`\n`);
        console.log(`[Generator] onCreateComplete`);
        Object.entries(files_not_exists)
            .forEach(function ([file, fpath2]) {
            let fpath = api.resolve(file);
            let exists = fs.existsSync(fpath);
            fs.ensureDir(path.dirname(fpath));
            if (exists) {
                console.log(`[Generator] overwrite ${file}`);
                let bak = fpath + '.bak';
                if (!fs.existsSync(bak)) {
                    fs.renameSync(fpath, bak);
                }
                fs.copyFileSync(fpath2, fpath);
            }
            else {
                console.log(`[Generator] create ${file}`);
                fs.copyFileSync(fpath2, fpath);
            }
        });
        try {
            //let json = readJSONSync(api.resolve('package.json')) as IPackageJsonFields;
        }
        catch (e) {
        }
        console.log(`\n`);
    });
}
function readJSONSync(file) {
    return JSON.parse(fs.readFileSync(file).toString());
}
module.exports = cliPluginMain;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSwrQkFBZ0M7QUFDaEMsNkJBQThCO0FBOEU5QixTQUFTLGFBQWEsQ0FBQyxHQUF3QixFQUM5QyxPQUFvRSxFQUNwRSxXQUF3QztJQUd4QyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFHekIsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFakIsSUFBSSxJQUFJLEdBQUcsRUFFVixDQUFDO1FBRUYsSUFBSSxPQUFPLEdBQUcsRUFFYixDQUFDO1FBRUYsSUFBSSxPQUFPLENBQUMsZ0JBQWdCLEVBQzVCO1lBQ0MsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLFNBQVMsQ0FBQztTQUNsQztRQUVELElBQUksT0FBTyxDQUFDLGNBQWMsRUFDMUI7WUFDQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsUUFBUSxDQUFDO1NBQy9CO1FBRUQsSUFBSSxPQUFPLENBQUMsY0FBYyxFQUMxQjtZQUNDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxRQUFRLENBQUM7U0FDL0I7UUFFRCxJQUFJLE9BQU8sQ0FBQyxtQkFBbUIsRUFDL0I7WUFDQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxRQUFRLENBQUM7U0FDckM7UUFFRCxJQUFJLE9BQU8sQ0FBQyxZQUFZLEVBQ3hCO1lBQ0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLFFBQVEsQ0FBQztTQUM1QjtRQUVELEdBQUcsQ0FBQyxZQUFZLEdBQUc7WUFFbEIsR0FBRyxJQUFJO1lBRVAsR0FBRyxHQUFHLENBQUMsWUFBWTtTQUNuQixDQUFDO1FBRUYsR0FBRyxDQUFDLGVBQWUsR0FBRztZQUVyQixHQUFHLE9BQU87WUFFVixhQUFhLEVBQUUsS0FBSztZ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LEtBQUssR0FBRyxNQUFNLENBQUM7Z0JBRXpCLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUN2QjtvQkFDQyxFQUFFLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztpQkFDMUI7Z0JBRUQsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDL0I7aUJBRUQ7Z0JBQ0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDMUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDL0I7UUFDRixDQUFDLENBQUMsQ0FDRjtRQUVELElBQ0E7WUFDQyw2RUFBNkU7U0FDN0U7UUFDRCxPQUFPLENBQUMsRUFDUjtTQUVDO1FBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuQixDQUFDLENBQUMsQ0FBQztBQUNKLENBQUM7QUFJRCxTQUFTLFlBQVksQ0FBb0IsSUFBWTtJQUVwRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0FBQ3JELENBQUM7QUFMRCxpQkFBUyxhQUFhLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJlc2V0SnNvbiA9IHJlcXVpcmUoJy4vcHJlc2V0Lmpzb24nKTtcbmltcG9ydCBQYWNrYWdlSnNvbiA9IHJlcXVpcmUoJy4vcGFja2FnZS5qc29uJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgX3Byb21wdHMgPSByZXF1aXJlKCcuL3Byb21wdHMnKTtcblxudHlwZSBJUHJvbXB0cyA9IHR5cGVvZiBfcHJvbXB0cztcblxudHlwZSBJQXJyYXlWYWx1ZU9mPFQ+ID0gVCBleHRlbmRzIChpbmZlciBVKVtdID8gVSA6IHN0cmluZztcblxudHlwZSBJUGFja2FnZUpzb25GaWVsZHMgPSBQYXJ0aWFsPHR5cGVvZiBQYWNrYWdlSnNvbj4gJiB7XG5cdHNjcmlwdHM/OiB7XG5cdFx0W25hbWU6IHN0cmluZ106IHN0cmluZyxcblx0fSxcblx0ZGVwZW5kZW5jaWVzPzoge1xuXHRcdFtuYW1lOiBzdHJpbmddOiBzdHJpbmcsXG5cdH0sXG5cdGRldkRlcGVuZGVuY2llcz86IHtcblx0XHRbbmFtZTogc3RyaW5nXTogc3RyaW5nLFxuXHR9LFxuXHRyZXNvbHV0aW9ucz86IHtcblx0XHRbbmFtZTogc3RyaW5nXTogc3RyaW5nLFxuXHR9LFxuXG5cdFtrZXk6IHN0cmluZ106IHVua25vd24sXG59XG5cbmludGVyZmFjZSBJVnVlQ2xpR2VuZXJhdG9yQXBpXG57XG5cdGV4dGVuZFBhY2thZ2U8VCBleHRlbmRzIHtcblx0XHRbazogc3RyaW5nXTogdW5rbm93bixcblx0fT4oZmllbGRzOiBUICYgSVBhY2thZ2VKc29uRmllbGRzIHwgKChwa2c6IFQgJiBJUGFja2FnZUpzb25GaWVsZHMpID0+IFQgJiBJUGFja2FnZUpzb25GaWVsZHMpKTogdm9pZFxuXG5cdHJlc29sdmUoX3BhdGg6IHN0cmluZyk6IHN0cmluZyxcblxuXHRoYXNQbHVnaW4oaWQ6IHN0cmluZyk6IGJvb2xlYW4sXG5cblx0b25DcmVhdGVDb21wbGV0ZShjYjogKCkgPT4gYW55KTogdm9pZCxcblxuXHRyZWFkb25seSBlbnRyeUZpbGU6IHN0cmluZyxcblx0aW5qZWN0SW1wb3J0cyhmaWxlOiBzdHJpbmcsIGNvZGUgOiBzdHJpbmcpOiB2b2lkXG59XG5cbmludGVyZmFjZSBJVnVlQ2xpR2VuZXJhdG9yT3B0aW9uc1xue1xuXHRfaXNQcmVzZXQ/OiBib29sZWFuLFxuXHRwcm9tcHRzPzogYm9vbGVhbixcblxuXHRbazogc3RyaW5nXTogdW5rbm93bixcbn1cblxudHlwZSBJVnVlQ2xpR2VuZXJhdG9yUm9vdE9wdGlvbnMgPSB0eXBlb2YgUHJlc2V0SnNvbiAmIHtcblx0cHJvamVjdE5hbWU6IHN0cmluZyxcblx0dXNlQ29uZmlnRmlsZXM6IGJvb2xlYW4sXG5cdHBsdWdpbnM6IHtcblx0XHRbazogc3RyaW5nXToge1xuXHRcdFx0W2s6IHN0cmluZ106IHVua25vd24sXG5cdFx0fVxuXHR9LFxuXHRyb3V0ZXI6IGJvb2xlYW4sXG5cdHJvdXRlckhpc3RvcnlNb2RlOiBib29sZWFuLFxuXHR2dWV4OiBib29sZWFuLFxuXHRjc3NQcmVwcm9jZXNzb3I6ICdkYXJ0LXNhc3MnIHwgJ25vZGUtc2FzcycgfCBzdHJpbmcsXG5cdGJhcmU6IHVua25vd24sXG5cblx0W2s6IHN0cmluZ106IHVua25vd24sXG59XG5cbnR5cGUgSVRTVmFsdWVPZjxUPiA9IFRba2V5b2YgVF07XG5cbmludGVyZmFjZSBJVnVlQ2xpR2VuZXJhdG9yT3B0aW9uc1RoaXNQbHVnaW5cbntcblx0cmVwbGFjZUZpbGVzOiBib29sZWFuLFxuXHRkZXBzQ3Jvc3NGZXRjaDogYm9vbGVhbixcblx0ZGVwc1Z1ZUhlYWRmdWw6IGJvb2xlYW4sXG5cdGRlcHNWdWVTZXNzaW9uOiBib29sZWFuLFxuXHRkZXBzQmx1ZWJpcmQ6IGJvb2xlYW4sXG5cblx0W2s6IHN0cmluZ106IHVua25vd24sXG59XG5cbmZ1bmN0aW9uIGNsaVBsdWdpbk1haW4oYXBpOiBJVnVlQ2xpR2VuZXJhdG9yQXBpLFxuXHRvcHRpb25zOiBJVnVlQ2xpR2VuZXJhdG9yT3B0aW9ucyAmIElWdWVDbGlHZW5lcmF0b3JPcHRpb25zVGhpc1BsdWdpbixcblx0cm9vdE9wdGlvbnM6IElWdWVDbGlHZW5lcmF0b3JSb290T3B0aW9ucyxcbik6IHZvaWRcbntcblx0YXBpLmV4dGVuZFBhY2thZ2UoKHBrZykgPT5cblx0e1xuXG5cdFx0Y29uc29sZS5sb2coYFtHZW5lcmF0b3JdIGV4dGVuZFBhY2thZ2VgKTtcblx0XHRjb25zb2xlLmRpcihwa2cpO1xuXG5cdFx0bGV0IGRlcHMgPSB7fSBhcyB7XG5cdFx0XHRbazogc3RyaW5nXTogc3RyaW5nLFxuXHRcdH07XG5cblx0XHRsZXQgZGVwc0RldiA9IHt9IGFzIHtcblx0XHRcdFtrOiBzdHJpbmddOiBzdHJpbmcsXG5cdFx0fTtcblxuXHRcdGlmIChvcHRpb25zLmRlcHNWdWVBbmFseXRpY3MpXG5cdFx0e1xuXHRcdFx0ZGVwc1tcInZ1ZS1hbmFseXRpY3NcIl0gPSBcIl41LjE2LjRcIjtcblx0XHR9XG5cblx0XHRpZiAob3B0aW9ucy5kZXBzVnVlSGVhZGZ1bClcblx0XHR7XG5cdFx0XHRkZXBzW1widnVlLWhlYWRmdWxcIl0gPSBcIl4yLjAuMVwiO1xuXHRcdH1cblxuXHRcdGlmIChvcHRpb25zLmRlcHNWdWVTZXNzaW9uKVxuXHRcdHtcblx0XHRcdGRlcHNbXCJ2dWUtc2Vzc2lvblwiXSA9IFwiXjEuMC4wXCI7XG5cdFx0fVxuXG5cdFx0aWYgKG9wdGlvbnMuZGVwc1Z1ZUdsb2JhbEV2ZW50cylcblx0XHR7XG5cdFx0XHRkZXBzW1widnVlLWdsb2JhbC1ldmVudHNcIl0gPSBcIl4xLjEuMlwiO1xuXHRcdH1cblxuXHRcdGlmIChvcHRpb25zLmRlcHNCbHVlYmlyZClcblx0XHR7XG5cdFx0XHRkZXBzW1wiYmx1ZWJpcmRcIl0gPSBcIl4zLjUuNFwiO1xuXHRcdH1cblxuXHRcdHBrZy5kZXBlbmRlbmNpZXMgPSB7XG5cblx0XHRcdC4uLmRlcHMsXG5cblx0XHRcdC4uLnBrZy5kZXBlbmRlbmNpZXMsXG5cdFx0fTtcblxuXHRcdHBrZy5kZXZEZXBlbmRlbmNpZXMgPSB7XG5cblx0XHRcdC4uLmRlcHNEZXYsXG5cblx0XHRcdFwiQHR5cGVzL25vZGVcIjogXCJeMTFcIixcblx0XHRcdFwiQGJsdWVsb3ZlcnMvdHNjb25maWdcIjogXCJeMS4wLjNcIixcblx0XHRcdFwiQHR5cGVzL3dlYnBhY2stY2hhaW5cIjogXCJeNS4yLjBcIixcblx0XHRcdFwidGVyc2VyXCI6IFwiMy4xNy4wXCIsXG5cdFx0XHRcInRlcnNlci13ZWJwYWNrLXBsdWdpblwiOiBcIl4xLjIuM1wiLFxuXG5cdFx0XHQuLi5wa2cuZGV2RGVwZW5kZW5jaWVzLFxuXHRcdH07XG5cblx0XHRyZXR1cm4gcGtnXG5cdH0pO1xuXG5cdGNvbnNvbGUubG9nKGBbR2VuZXJhdG9yXSBvcHRpb25zYCk7XG5cdGNvbnNvbGUuZGlyKG9wdGlvbnMpO1xuXG5cdGNvbnNvbGUubG9nKGBbR2VuZXJhdG9yXSByb290T3B0aW9uc2ApO1xuXHRjb25zb2xlLmRpcihyb290T3B0aW9ucyk7XG5cblx0YXBpLmluamVjdEltcG9ydHMoYXBpLmVudHJ5RmlsZSwgYGltcG9ydCB7IHByb2R1Y3Rpb24sIGRldmVsb3BtZW50IH0gZnJvbSAnQC9saWIvY29uc3QnYCk7XG5cblx0bGV0IGZpbGVzX25vdF9leGlzdHMgPSBPYmplY3QuZW50cmllcyhbXG5cdFx0XHQndHNjb25maWcuanNvbicsXG5cdFx0XHQnLmJyb3dzZXJzbGlzdHJjJyxcblx0XHRdLnJlZHVjZSgoYSwgZmlsZSkgPT5cblx0XHR7XG5cdFx0XHRhW2ZpbGVdID0gZmlsZTtcblxuXHRcdFx0cmV0dXJuIGFcblx0XHR9LCBPYmplY3QuZW50cmllcyh7XG5cdFx0XHQnLmdpdGlnbm9yZSc6ICdnaXRpZ25vcmUnLFxuXHRcdFx0Jy5udm1yYyc6ICdudm1yYycsXG5cdFx0XHQncHVibGljL25vamVreWxsJzogJ25vamVreWxsJyxcblx0XHR9KS5yZWR1Y2UoKGEsIFtmaWxlLCBmaWxlMl0pID0+XG5cdFx0e1xuXG5cdFx0XHRmaWxlMiA9IHBhdGguam9pbignZG90JywgZmlsZTIpO1xuXHRcdFx0YVtmaWxlXSA9IGZpbGUyO1xuXG5cdFx0XHRyZXR1cm4gYTtcblx0XHR9LCAoKCkgPT4ge1xuXHRcdFx0bGV0IHJldCA9IHtcblx0XHRcdFx0J3B1YmxpYy9faGVhZGVycyc6ICdfaGVhZGVycycsXG5cdFx0XHRcdCdzcmMvbGliL2NvbnN0LnRzJzogJ3NyYy9saWIvY29uc3QudHMnLFxuXHRcdFx0fSBhcyB7XG5cdFx0XHRcdFtmaWxlOiBzdHJpbmddOiBzdHJpbmcsXG5cdFx0XHR9O1xuXG5cdFx0XHRpZiAob3B0aW9ucy5kZXBzVnVlQW5hbHl0aWNzKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXRbJ3NyYy9wbHVnaW5zL3Z1ZS1hbmFseXRpY3MudHMnXSA9ICdzcmMvcGx1Z2lucy92dWUtYW5hbHl0aWNzLnRzJztcblxuXHRcdFx0XHRhcGkuaW5qZWN0SW1wb3J0cyhhcGkuZW50cnlGaWxlLCBgaW1wb3J0ICdAL3BsdWdpbnMvdnVlLWFuYWx5dGljcydgKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHJldDtcblx0XHR9KSkoKSkpXG5cdFx0LnJlZHVjZSgoYSwgW2ZpbGUsIGZpbGUyXSkgPT5cblx0XHR7XG5cblx0XHRcdGxldCBmcGF0aCA9IGFwaS5yZXNvbHZlKGZpbGUpO1xuXHRcdFx0bGV0IGV4aXN0cyA9IGZzLmV4aXN0c1N5bmMoZnBhdGgpO1xuXG5cdFx0XHRpZiAoIWV4aXN0cyB8fCBvcHRpb25zLnJlcGxhY2VGaWxlcylcblx0XHRcdHtcblx0XHRcdFx0bGV0IGZwYXRoMiA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdmaWxlcycsIGZpbGUyKTtcblx0XHRcdFx0bGV0IGV4aXN0czIgPSBmcy5leGlzdHNTeW5jKGZwYXRoMik7XG5cblx0XHRcdFx0aWYgKGV4aXN0czIpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAoZXhpc3RzKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGxldCBiYWsgPSBmcGF0aCArICcuYmFrJztcblxuXHRcdFx0XHRcdFx0aWYgKGZzLmV4aXN0c1N5bmMoYmFrKSlcblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0aWYgKCFmcy5yZWFkRmlsZVN5bmMoZnBhdGgpLmVxdWFscyhmcy5yZWFkRmlsZVN5bmMoYmFrKSkpXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhgW0dlbmVyYXRvcl0gYmFja3VwICR7ZmlsZX1gKTtcblxuXHRcdFx0XHRcdFx0XHRcdGZzLnVubGlua1N5bmMoYmFrKTtcblx0XHRcdFx0XHRcdFx0XHRmcy5jb3B5RmlsZVN5bmMoZnBhdGgsIGJhayk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coYFtHZW5lcmF0b3JdIHNraXAgYmFja3VwICR7ZmlsZX1gKTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhgW0dlbmVyYXRvcl0gYmFja3VwICR7ZmlsZX1gKTtcblx0XHRcdFx0XHRcdFx0ZnMuY29weUZpbGVTeW5jKGZwYXRoLCBiYWspO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGFbZmlsZV0gPSBmcGF0aDI7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGFcblx0XHR9LCB7fSBhcyB7XG5cdFx0XHRbZmlsZTogc3RyaW5nXTogc3RyaW5nLFxuXHRcdH0pXG5cdDtcblxuXHRhcGkub25DcmVhdGVDb21wbGV0ZSgoKSA9PlxuXHR7XG5cdFx0Y29uc29sZS5sb2coYFxcbmApO1xuXG5cdFx0Y29uc29sZS5sb2coYFtHZW5lcmF0b3JdIG9uQ3JlYXRlQ29tcGxldGVgKTtcblxuXHRcdE9iamVjdC5lbnRyaWVzKGZpbGVzX25vdF9leGlzdHMpXG5cdFx0XHQuZm9yRWFjaChmdW5jdGlvbiAoW2ZpbGUsIGZwYXRoMl0pXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBmcGF0aCA9IGFwaS5yZXNvbHZlKGZpbGUpO1xuXHRcdFx0XHRsZXQgZXhpc3RzID0gZnMuZXhpc3RzU3luYyhmcGF0aCk7XG5cblx0XHRcdFx0ZnMuZW5zdXJlRGlyKHBhdGguZGlybmFtZShmcGF0aCkpO1xuXG5cdFx0XHRcdGlmIChleGlzdHMpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhgW0dlbmVyYXRvcl0gb3ZlcndyaXRlICR7ZmlsZX1gKTtcblxuXHRcdFx0XHRcdGxldCBiYWsgPSBmcGF0aCArICcuYmFrJztcblxuXHRcdFx0XHRcdGlmICghZnMuZXhpc3RzU3luYyhiYWspKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGZzLnJlbmFtZVN5bmMoZnBhdGgsIGJhayk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0ZnMuY29weUZpbGVTeW5jKGZwYXRoMiwgZnBhdGgpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Vcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKGBbR2VuZXJhdG9yXSBjcmVhdGUgJHtmaWxlfWApO1xuXHRcdFx0XHRcdGZzLmNvcHlGaWxlU3luYyhmcGF0aDIsIGZwYXRoKTtcblx0XHRcdFx0fVxuXHRcdFx0fSlcblx0XHQ7XG5cblx0XHR0cnlcblx0XHR7XG5cdFx0XHQvL2xldCBqc29uID0gcmVhZEpTT05TeW5jKGFwaS5yZXNvbHZlKCdwYWNrYWdlLmpzb24nKSkgYXMgSVBhY2thZ2VKc29uRmllbGRzO1xuXHRcdH1cblx0XHRjYXRjaCAoZSlcblx0XHR7XG5cblx0XHR9XG5cblx0XHRjb25zb2xlLmxvZyhgXFxuYCk7XG5cdH0pO1xufVxuXG5leHBvcnQgPSBjbGlQbHVnaW5NYWluXG5cbmZ1bmN0aW9uIHJlYWRKU09OU3luYzxUIGV4dGVuZHMgdW5rbm93bj4oZmlsZTogc3RyaW5nKTogVFxue1xuXHRyZXR1cm4gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoZmlsZSkudG9TdHJpbmcoKSk7XG59Il19